from kivy.app import App
from kivy.uix.boxlayout import BoxLayout
from kivy.uix.button import Button
from kivy.uix.label import Label
from kivy_garden.graph import Graph, MeshLinePlot
import random
from datetime import datetime, timedelta
import pandas as pd
import matplotlib.pyplot as plt
from kivy.garden.matplotlib.backend_kivyagg import FigureCanvasKivyAgg
from mplfinance.original_flavor import candlestick_ohlc
import matplotlib.dates as mdates

from kivy.app import App
from kivy.lang import Builder
from kivy.uix.boxlayout import BoxLayout
from kivy.garden.matplotlib import FigureCanvasKivyAgg
from matplotlib import pyplot as plt
import mplfinance as mpf
import numpy as np
import pandas as pd
from datetime import datetime, timedelta



from kivy.lang import Builder


from kivy.app import App
from kivy.lang import Builder
from kivy.uix.boxlayout import BoxLayout
from kivy.garden.matplotlib import FigureCanvasKivyAgg
from matplotlib import pyplot as plt
import mplfinance as mpf
import numpy as np
import pandas as pd
from datetime import datetime, timedelta
from kivy.uix.button import Button
from kivy.uix.label import Label

kv_layout = '''
TradingInterface:
    orientation: 'vertical'
    Label:
        text: "TradingSimulator"
        size_hint_y: 0.1
    Label:
        id: earnings_label
        text: "Earnings: $0"
        size_hint_y: 0.1
    BoxLayout:
        id: chart_area
        size_hint_y: 0.7
    BoxLayout:
        orientation: "horizontal"
        size_hint_y: 0.1
        Button:
            text: "Buy"
            on_press: root.buy_action(self)
        Button:
            text: "Sell"
            on_press: root.sell_action(self)
        Button:
            text: "Pass"
            on_press: root.pass_action(self)
    Button:
        id: start_button
        text: "Start"
        on_press: root.start_game(self)
        size_hint_y: 0.1
'''

class TradingSimulatorApp(App):
    def build(self):
        return Builder.load_string(kv_layout)


class TradingInterface(BoxLayout):
    def __init__(self, **kwargs):
        super(TradingInterface, self).__init__(**kwargs)
        self.main_layout = BoxLayout(orientation='vertical')

        self.chart_canvas = None

#        self.start_button = Button(text='Start', on_press=self.start_game)
#        self.main_layout.add_widget(self.start_button)
#        self.add_widget(self.main_layout)

        self.current_graph = None

        # Sample data
        self.OHLC_data = [[135013, 135252, 134780, 134814], [134808, 134933, 134472, 134484],
                     [134484, 134563, 134335, 134387], [134392, 134512, 134307, 134427],
                     [134421, 134432, 134205, 134358], [134358, 134404, 134193, 134239],
                     [134233, 134330, 134131, 134199], [134205, 134222, 134125, 134159],
                     [134159, 134216, 134085, 134136], [134131, 134182, 134062, 134085],
                     [134091, 134210, 134039, 134199], [134193, 134318, 134068, 134233],
                     [134239, 134347, 133931, 134034], [134028, 134045, 133846, 133982],
                     [133982, 134125, 133908, 134096], [134091, 134392, 134091, 134347],
                     [134347, 134552, 134256, 134552], [134546, 134620, 134438, 134620],
                     [134620, 134706, 134461, 134580], [134580, 134825, 134273, 134819],
                     [134819, 134865, 134614, 134626], [134626, 134780, 134495, 134580],
                     [134575, 134689, 134501, 134501], [134506, 134666, 134461, 134643],
                     [134637, 134785, 134324, 134421], [134421, 134620, 134410, 134552],
                     [134552, 134660, 134472, 134580], [134580, 134740, 134466, 134694],
                     [134689, 134734, 134489, 134711], [134711, 134734, 134466, 134609],
                     [134609, 134996, 134569, 134985], [134985, 135036, 134780, 134814],
                     [134814, 134814, 134489, 134552], [134546, 134597, 134330, 134398],
                     [134404, 134654, 134387, 134592], [134586, 134689, 134387, 134432],
                     [134438, 134859, 134421, 134819], [134819, 134831, 134529, 134580],
                     [134575, 134848, 134569, 134751], [134751, 134757, 134501, 134580],
                     [134575, 134643, 134506, 134643], [134643, 134671, 134381, 134427],
                     [134427, 134472, 134227, 134387], [134387, 134523, 134301, 134484],
                     [134484, 134535, 134358, 134381], [134375, 134466, 134301, 134358],
                     [134358, 134364, 134125, 134142], [134136, 134364, 134108, 134324],
                     [134324, 134398, 134244, 134256], [134261, 134421, 134244, 134341],
                     [134341, 134444, 134307, 134427], [134421, 134529, 134387, 134489],
                     [134484, 134552, 134427, 134535], [134540, 134580, 134461, 134529],
                     [134523, 134569, 134421, 134438], [134438, 134540, 134404, 134472],
                     [134478, 134654, 134444, 134444], [134444, 134552, 134364, 134410],
                     [134415, 134586, 134392, 134569], [134563, 134717, 134546, 134666],
                     [134666, 134882, 134643, 134848], [134842, 134854, 134666, 134711],
                     [134717, 134871, 134677, 134734], [134734, 134791, 134694, 134723],
                     [134728, 134848, 134717, 134774], [134780, 134990, 134774, 134865],
                     [134865, 134990, 134797, 134842], [134842, 134950, 134797, 134825],
                     [134831, 134871, 134774, 134825], [134825, 134865, 134700, 134768],
                     [134768, 134893, 134740, 134848], [134854, 135184, 134831, 135144],
                     [135138, 135269, 135064, 135195], [135195, 135224, 135059, 135087],
                     [135087, 135087, 134985, 135047], [135047, 135076, 134911, 134928],
                     [134922, 134950, 134768, 134905], [134911, 135076, 134893, 134945],
                     [134950, 135076, 134916, 135053], [135053, 135207, 135007, 135184],
                     [135184, 135389, 135070, 135377], [135377, 135412, 135292, 135343],
                     [135338, 135474, 135315, 135423], [135423, 135537, 135395, 135503],
                     [135503, 135634, 135480, 135543], [135548, 135560, 135423, 135457],
                     [135463, 135827, 135417, 135805], [135810, 135844, 135696, 135753],
                     [135753, 135759, 135628, 135685], [135685, 135787, 135611, 135662],
                     [135662, 135793, 135634, 135770], [135770, 135879, 135674, 135867],
                     [135867, 136009, 135856, 135918], [135924, 135964, 135810, 135839],
                     [135844, 135867, 135628, 135639], [135634, 135645, 135383, 135491],
                     [135491, 135565, 135423, 135543], [135543, 135605, 135434, 135474],
                     [135474, 135531, 135412, 135491], [135497, 135605, 135486, 135526],
                     [135526, 135531, 135434, 135480], [135474, 135554, 135474, 135520],
                     [135526, 135708, 135508, 135588], [135588, 135668, 135548, 135605],
                     [135605, 135639, 135560, 135600], [135600, 135622, 135486, 135491],
                     [135491, 135582, 135451, 135469], [135844, 135844, 135207, 135389],
                     [135389, 135406, 135104, 135121], [135121, 135190, 134922, 134950],
                     [134950, 134979, 134848, 134893], [134893, 134939, 134831, 134848],
                     [134848, 134928, 134802, 134922], [134928, 135161, 134916, 135155],
                     [135155, 135184, 134979, 135007], [135013, 135036, 134831, 134945],
                     [134945, 134956, 134842, 134865], [134865, 134916, 134780, 134848],
                     [134848, 134899, 134780, 134780], [134780, 134797, 134540, 134603],
                     [134603, 134717, 134563, 134694], [134700, 134888, 134671, 134854],
                     [134854, 135059, 134848, 134979], [134979, 135036, 134865, 134985],
                     [134985, 135019, 134723, 134763], [134763, 134848, 134341, 134461],
                     [134461, 134597, 134410, 134529], [134523, 134540, 134279, 134301],
                     [134301, 134324, 133982, 134022], [134022, 134068, 133852, 133869],
                     [133863, 133954, 133823, 133880], [133874, 134301, 133874, 134170],
                     [134170, 134301, 134125, 134256], [134250, 134364, 134187, 134353],
                     [134358, 134478, 134273, 134466], [134466, 134529, 134347, 134518],
                     [134512, 134825, 134512, 134763], [134768, 135036, 134745, 134899],
                     [134893, 135019, 134842, 134956], [134950, 135081, 134905, 134996],
                     [134990, 135138, 134791, 134797], [134797, 135264, 134791, 135098],
                     [135093, 135252, 135047, 135218], [135218, 135343, 135150, 135172],
                     [135178, 135292, 135127, 135269], [135269, 135338, 135207, 135264],
                     [135269, 135400, 135201, 135298], [135298, 135395, 135258, 135326],
                     [135326, 135343, 135241, 135286], [135292, 135451, 135286, 135400],
                     [135400, 135440, 135190, 135195], [135195, 135247, 135019, 135030],
                     [135024, 135070, 134956, 135019], [135013, 135087, 134939, 135002],
                     [135002, 135087, 134979, 135013], [135013, 135144, 134916, 135076],
                     [135076, 135190, 135036, 135144], [135138, 135167, 135064, 135104],
                     [135110, 135150, 135030, 135116], [135121, 135167, 135036, 135070],
                     [135076, 135195, 135064, 135172], [135172, 135258, 135138, 135167],
                     [135167, 135241, 135133, 135235], [135235, 135286, 135218, 135247],
                     [135241, 135286, 135195, 135252], [135258, 135355, 135229, 135343],
                     [135349, 135355, 135178, 135229], [135229, 135235, 135104, 135201],
                     [135207, 135303, 135172, 135275], [135281, 135389, 135258, 135360],
                     [135360, 135366, 135121, 135133], [135133, 135150, 135053, 135064],
                     [135064, 135144, 135013, 135098], [135098, 135127, 135047, 135064],
                     [135064, 135127, 135042, 135093], [135087, 135093, 134922, 135002],
                     [135002, 135002, 134819, 134825], [134819, 134882, 134689, 134797],
                     [134797, 134939, 134751, 134899], [134899, 134973, 134825, 134882],
                     [134882, 134922, 134774, 134859], [134854, 134871, 134751, 134808],
                     [134814, 134837, 134740, 134814], [134814, 134922, 134774, 134808],
                     [134808, 134854, 134666, 134814], [134814, 134842, 134706, 134802],
                     [134802, 134922, 134763, 134888], [134893, 134916, 134814, 134842],
                     [134842, 134899, 134802, 134831], [134831, 135042, 134808, 134962],
                     [134956, 135013, 134933, 134979], [134979, 134996, 134785, 134814],
                     [134808, 134842, 134711, 134728], [134723, 134876, 134654, 134763],
                     [134763, 134893, 134717, 134768], [134768, 134859, 134728, 134848],
                     [134848, 134922, 134831, 134916], [134916, 134973, 134859, 134893],
                     [134899, 134905, 134643, 134649], [134654, 134808, 134620, 134791],
                     [134791, 134842, 134751, 134802], [134797, 134848, 134666, 134751],
                     [134745, 134780, 134535, 134649], [134649, 134814, 134643, 134768],
                     [134768, 134962, 134763, 134893], [134899, 134899, 134740, 134740],
                     [134745, 134876, 134723, 134859], [134859, 134882, 134785, 134871],
                     [134876, 134888, 134831, 134865], [134865, 134950, 134837, 134854],
                     [134859, 134871, 134757, 134848], [134848, 134882, 134763, 134854],
                     [134854, 134916, 134819, 134905], [134905, 134928, 134632, 134751],
                     [134062, 134182, 133709, 134136], [134142, 134148, 133920, 133988],
                     [133988, 134079, 133874, 133960], [133954, 134045, 133846, 134039],
                     [134039, 134102, 133760, 133766], [133766, 133954, 133675, 133760],
                     [133760, 133817, 133481, 133533], [133533, 133738, 133521, 133715],
                     [133721, 133800, 133533, 133573], [133573, 133675, 133573, 133607],
                     [133607, 133652, 133470, 133504], [133510, 133567, 133368, 133379],
                     [133373, 133487, 133208, 133237], [133237, 133481, 133214, 133459],
                     [133453, 133498, 133294, 133413], [133413, 133698, 133407, 133601],
                     [133601, 133652, 133493, 133573], [133573, 133772, 133550, 133772],
                     [133766, 133806, 133350, 133686], [133692, 133772, 133345, 133373],
                     [133373, 133681, 133305, 133652], [133658, 133863, 133567, 133686],
                     [133686, 133846, 133538, 133823], [133829, 134028, 133817, 133977],
                     [133977, 134125, 133789, 133800], [133800, 133937, 133692, 133880],
                     [133880, 133931, 133709, 133777], [133777, 133891, 133743, 133817],
                     [133817, 134017, 133800, 133863], [133869, 133926, 133698, 133834],
                     [133829, 133943, 133658, 133726], [133721, 133834, 133578, 133578],
                     [133578, 133709, 133413, 133436], [133436, 133709, 133424, 133652],
                     [133658, 133789, 133595, 133755], [133749, 133783, 133669, 133721],
                     [133715, 133760, 133641, 133698], [133698, 133743, 133550, 133578],
                     [133578, 133721, 133464, 133533], [133533, 133618, 133516, 133584],
                     [133578, 133629, 133379, 133498], [133498, 133516, 133379, 133385],
                     [133390, 133527, 133362, 133481], [133476, 133573, 133476, 133555],
                     [133561, 133612, 133521, 133584], [133584, 133686, 133521, 133578],
                     [133578, 133709, 133521, 133635], [133635, 133675, 133561, 133607],
                     [133607, 133738, 133601, 133715], [133715, 133789, 133698, 133772],
                     [133777, 133800, 133709, 133783], [133783, 133886, 133755, 133834],
                     [133834, 133840, 133732, 133766], [133772, 133806, 133664, 133709],
                     [133709, 133800, 133692, 133772], [133772, 133914, 133715, 133732],
                     [133738, 133738, 133612, 133629], [133629, 133772, 133595, 133664],
                     [133658, 133681, 133527, 133573], [133573, 133607, 133481, 133521],
                     [133521, 133749, 133521, 133726], [133726, 133800, 133669, 133738],
                     [133732, 133840, 133692, 133766], [133766, 133800, 133681, 133755],
                     [133755, 133806, 133601, 133624], [133624, 133681, 133567, 133681],
                     [133681, 133743, 133664, 133738], [133732, 133795, 133647, 133726],
                     [133726, 133817, 133647, 133698], [133703, 133789, 133681, 133698],
                     [133698, 133806, 133652, 133800], [133795, 133988, 133772, 133965],
                     [133960, 133988, 133726, 133743], [133743, 133965, 133715, 133869],
                     [133863, 133903, 133721, 133749], [133743, 133772, 133664, 133709],
                     [133709, 133760, 133601, 133647], [133641, 133709, 133612, 133641],
                     [133647, 133726, 133544, 133709], [133715, 133755, 133595, 133635],
                     [133629, 133681, 133447, 133550], [133550, 133658, 133527, 133573],
                     [133578, 133635, 133493, 133555], [133555, 133641, 133527, 133573],
                     [133578, 133726, 133567, 133629], [133624, 133709, 133584, 133698],
                     [133703, 133749, 133629, 133698], [133698, 133709, 133590, 133607],
                     [133612, 133766, 133561, 133664], [133664, 133703, 133573, 133595],
                     [133595, 133607, 133328, 133339], [133345, 133447, 133328, 133447],
                     [133447, 133527, 133362, 133464], [133464, 133521, 133396, 133459],
                     [133453, 133527, 133259, 133368], [133373, 133385, 132952, 133140],
                     [133145, 133254, 133083, 133174], [133174, 133242, 133134, 133163],
                     [133157, 133174, 133043, 133071], [133077, 133157, 133071, 133123],
                     [133123, 133128, 132986, 133060], [133066, 133248, 133060, 133197],
                     [133197, 133214, 133066, 133094], [133089, 133214, 133089, 133168],
                     [133168, 133237, 133106, 133191], [133185, 133254, 133100, 133219],
                     [133225, 133305, 133197, 133219], [133715, 134017, 133595, 133965],
                     [133960, 134028, 133772, 133965], [133971, 134005, 133647, 133755],
                     [133755, 133812, 133692, 133715], [133709, 133886, 133675, 133846],
                     [133846, 133954, 133669, 133800], [133800, 134484, 133800, 134472],
                     [134472, 134506, 134233, 134330], [134330, 134632, 134250, 134535],
                     [134535, 134780, 134512, 134711], [134711, 134871, 134518, 134814],
                     [134808, 134985, 134797, 134865], [134859, 134871, 134694, 134745],
                     [134745, 134848, 134637, 134740], [134734, 135007, 134700, 134979],
                     [134979, 135047, 134751, 134757], [134757, 134819, 134677, 134706],
                     [134711, 134831, 134609, 134643], [134643, 134666, 134404, 134484],
                     [134484, 134717, 134301, 134643], [134643, 134740, 134466, 134535],
                     [134540, 134723, 134364, 134375], [134381, 134461, 134330, 134449],
                     [134444, 134575, 134375, 134489], [134489, 134518, 134165, 134244],
                     [134239, 134301, 134119, 134153], [134153, 134210, 134039, 134142],
                     [134136, 134205, 134051, 134176], [134176, 134250, 134079, 134102],
                     [134102, 134113, 133988, 134017], [134022, 134079, 133988, 134028],
                     [134028, 134199, 133948, 134068], [134062, 134148, 134011, 134131],
                     [134125, 134290, 134045, 134148], [134148, 134222, 134125, 134170],
                     [134176, 134222, 134022, 134051], [134051, 134125, 133960, 134074],
                     [134074, 134119, 133795, 133829], [133823, 133908, 133777, 133834],
                     [133840, 134051, 133755, 133994], [133994, 134022, 133891, 133943],
                     [133943, 134125, 133891, 134102], [134096, 134244, 134062, 134068],
                     [134068, 134193, 133982, 134108], [134108, 134153, 134068, 134108],
                     [134113, 134170, 134045, 134148], [134148, 134153, 133971, 134091],
                     [134091, 134159, 134011, 134045], [134039, 134051, 133908, 133943],
                     [133937, 133948, 133760, 133863], [133857, 133920, 133823, 133880],
                     [133880, 134102, 133834, 134028], [134022, 134045, 133897, 133914],
                     [133920, 133931, 133800, 133897], [133891, 133943, 133812, 133817],
                     [133823, 133840, 133527, 133789], [133789, 133795, 133658, 133760],
                     [133760, 133840, 133652, 133834], [133829, 133897, 133698, 133715],
                     [133715, 133834, 133635, 133772], [133777, 133852, 133698, 133789],
                     [133789, 133880, 133738, 133777], [133777, 133960, 133760, 133874],
                     [133880, 133897, 133738, 133817], [133817, 133914, 133703, 133743],
                     [133743, 133777, 133675, 133726], [133726, 133743, 133578, 133681],
                     [133686, 133789, 133612, 133624], [133629, 133629, 133163, 133185],
                     [133180, 133328, 133106, 133294], [133294, 133356, 133054, 133128],
                     [133123, 133202, 133049, 133117], [133117, 133219, 133066, 133191],
                     [133185, 133271, 132992, 133077], [133077, 133094, 132679, 132696],
                     [132690, 132736, 132468, 132542], [132542, 132701, 132485, 132513],
                     [132513, 132553, 132382, 132451], [132451, 132508, 132337, 132457],
                     [132457, 132570, 132400, 132536], [132536, 132559, 132451, 132531],
                     [132531, 132622, 132525, 132599], [132599, 132599, 132422, 132536],
                     [132536, 132639, 132519, 132593], [132593, 132644, 132280, 132371],
                     [132371, 132428, 132172, 132229], [132229, 132314, 132178, 132252],
                     [132252, 132343, 132229, 132337], [132337, 132377, 132280, 132303],
                     [132303, 132360, 132263, 132348], [132343, 132491, 132320, 132457],
                     [132457, 132690, 132439, 132679], [132684, 132753, 132570, 132639],
                     [132639, 132753, 132599, 132673], [132679, 132707, 132513, 132639],
                     [132644, 132656, 132474, 132479], [132479, 132502, 132308, 132400],
                     [132405, 132462, 132280, 132417], [132417, 132422, 132320, 132388],
                     [132388, 132400, 132303, 132360], [132354, 132411, 132331, 132400],
                     [132405, 132553, 132400, 132434], [132434, 132536, 132365, 132479],
                     [132474, 132616, 132462, 132593], [132593, 132650, 132519, 132565],
                     [132570, 132650, 132485, 132639], [132639, 132701, 132474, 132701],
                     [132992, 133267, 132802, 133015], [133015, 133071, 132690, 132780],
                     [132774, 132953, 132724, 132936], [132942, 133043, 132841, 132869],
                     [132869, 132987, 132796, 132903], [132908, 133065, 132824, 133009],
                     [133009, 133110, 132813, 132976], [132976, 133004, 132796, 132836],
                     [132836, 133227, 132824, 133194], [133194, 133199, 132914, 132942],
                     [132936, 133020, 132886, 132925], [132920, 133099, 132841, 133076],
                     [133076, 133267, 133015, 133043], [133043, 133149, 132858, 132936],
                     [132936, 133160, 132869, 132981], [132976, 133071, 132836, 132886],
                     [132886, 133127, 132824, 132858], [132852, 132875, 132617, 132763],
                     [132769, 132948, 132662, 132830], [132824, 133188, 132707, 133188],
                     [133183, 133339, 132953, 133009], [133009, 133060, 132735, 132763],
                     [132763, 132847, 132713, 132847], [132847, 132886, 132662, 132785],
                     [132791, 132847, 132511, 132629], [132629, 132757, 132595, 132696],
                     [132696, 132741, 132556, 132685], [132685, 132836, 132573, 132802],
                     [132808, 132897, 132752, 132763], [132763, 132769, 132584, 132595],
                     [132595, 132651, 132483, 132584], [132584, 132623, 132505, 132601],
                     [132595, 132796, 132477, 132774], [132774, 132796, 132690, 132729],
                     [132729, 132746, 132505, 132522], [132522, 132718, 132472, 132657],
                     [132657, 132774, 132623, 132729], [132729, 132824, 132724, 132785],
                     [132780, 132791, 132589, 132724], [132724, 132948, 132673, 132897],
                     [132903, 132959, 132729, 132741], [132741, 132752, 132612, 132724],
                     [132724, 132875, 132685, 132869], [132869, 132948, 132505, 132550],
                     [132545, 132757, 132494, 132735], [132741, 132819, 132612, 132668],
                     [132673, 132685, 132405, 132472], [132477, 132629, 132438, 132623],
                     [132623, 132808, 132584, 132757], [132757, 132864, 132724, 132824],
                     [132830, 132864, 132713, 132796], [132802, 132813, 132668, 132746],
                     [132746, 132841, 132713, 132841], [132841, 133043, 132757, 133032],
                     [133032, 133155, 132992, 133043], [133037, 133060, 132808, 132892],
                     [132892, 133015, 132841, 132976], [132976, 133071, 132920, 133065],
                     [133065, 133115, 132936, 132998], [132998, 133300, 132998, 133283],
                     [133283, 133490, 133272, 133401], [133395, 133608, 133390, 133563],
                     [133563, 133709, 133518, 133608], [133614, 133692, 133586, 133619],
                     [133614, 133675, 133591, 133591], [133597, 133608, 133379, 133395],
                     [133395, 133462, 133334, 133406], [133412, 133418, 133311, 133334],
                     [133328, 133379, 133227, 133244], [133244, 133255, 133043, 133060],
                     [133060, 133071, 132713, 132841], [132841, 132970, 132819, 132925],
                     [132925, 133015, 132824, 132875], [132880, 133110, 132819, 132976],
                     [132981, 133020, 132780, 132830], [132830, 133004, 132763, 132987],
                     [132981, 133149, 132948, 133121], [133115, 133244, 133088, 133199],
                     [133199, 133216, 133060, 133099], [133099, 133138, 132981, 133127],
                     [133127, 133295, 133110, 133272], [133272, 133362, 133233, 133328],
                     [133328, 133356, 133199, 133227], [133233, 133267, 133143, 133155],
                     [133155, 133183, 133032, 133043], [133043, 133194, 132998, 133060],
                     [133060, 133076, 132976, 132987], [132981, 133037, 132942, 132998],
                     [132998, 133048, 132931, 132948], [132948, 133104, 132869, 133099],
                     [133099, 133160, 133043, 133099], [133099, 133115, 132942, 132998],
                     [132992, 133043, 132892, 133032], [133032, 133222, 132998, 133211],
                     [133216, 133300, 133076, 133104], [133110, 133160, 132864, 132931],
                     [132931, 133060, 132875, 133026], [133020, 133071, 132925, 132976],
                     [132976, 133060, 132959, 133020], [133026, 133143, 132992, 133121],
                     [133127, 133250, 133082, 133199], [133199, 133267, 133177, 133222],
                     [133222, 133323, 133127, 133295], [133289, 133384, 133194, 133199],
                     [133199, 133267, 133160, 133183], [133177, 133339, 133160, 133323],
                     [133323, 133395, 133177, 133177], [132914, 132959, 132606, 132752],
                     [132746, 132875, 132735, 132824], [132824, 132903, 132763, 132847],
                     [132841, 132987, 132830, 132908], [132908, 132953, 132780, 132920],
                     [132920, 132981, 132886, 132920], [132920, 133043, 132696, 132696],
                     [132696, 132780, 132584, 132645], [132651, 132763, 132606, 132757],
                     [132757, 132808, 132673, 132724], [132729, 132729, 132601, 132606],
                     [132606, 132657, 132511, 132550], [132550, 132556, 132270, 132422],
                     [132427, 132595, 132394, 132455], [132450, 132640, 132354, 132606],
                     [132606, 132785, 132595, 132662], [132662, 132886, 132584, 132813],
                     [132813, 132892, 132746, 132875], [132875, 132908, 132623, 132673],
                     [132673, 132976, 132673, 132752], [132757, 132763, 132444, 132450],
                     [132450, 132461, 132242, 132382], [132382, 132455, 132159, 132203],
                     [132203, 132556, 132164, 132489], [132483, 132763, 132483, 132707],
                     [132707, 132713, 132242, 132259], [132265, 132466, 132237, 132410],
                     [132416, 132584, 132298, 132528], [132533, 132651, 132494, 132556],
                     [132556, 132718, 132528, 132662], [132657, 132769, 132589, 132657],
                     [132657, 132685, 132505, 132567], [132561, 132701, 132556, 132578],
                     [132578, 132612, 132377, 132444], [132438, 132444, 132091, 132226],
                     [132226, 132248, 132125, 132214], [132214, 132438, 132170, 132394],
                     [132394, 132399, 132259, 132349], [132349, 132427, 132254, 132405],
                     [132410, 132433, 132332, 132388], [132394, 132500, 132270, 132494],
                     [132489, 132545, 132438, 132511], [132511, 132545, 132433, 132461],
                     [132461, 132511, 132332, 132354], [132349, 132371, 132103, 132164],
                     [132170, 132237, 132024, 132080], [132075, 132080, 131873, 131884],
                     [131884, 131985, 131845, 131963], [131963, 131963, 131761, 131823],
                     [131817, 131884, 131772, 131879], [131879, 131907, 131789, 131840],
                     [131840, 131873, 131739, 131851], [131856, 131929, 131812, 131918],
                     [131918, 131951, 131856, 131867], [131867, 131923, 131761, 131895],
                     [131895, 131923, 131750, 131784], [131789, 131812, 131638, 131711],
                     [131716, 131795, 131683, 131750], [131750, 131806, 131716, 131772],
                     [131772, 131828, 131761, 131772], [131772, 131795, 131666, 131688],
                     [131694, 131711, 131593, 131705], [131705, 131800, 131688, 131694],
                     [131688, 131789, 131655, 131772], [131767, 131823, 131722, 131800],
                     [131800, 131817, 131728, 131739], [131744, 131879, 131739, 131867],
                     [131867, 131929, 131817, 131834], [131840, 132002, 131800, 131946],
                     [131951, 132097, 131929, 131985], [131979, 132063, 131940, 131991],
                     [131991, 132080, 131963, 132024], [132030, 132153, 132024, 132108],
                     [132103, 132125, 132047, 132097], [132103, 132136, 132052, 132086],
                     [132086, 132119, 132024, 132030], [132030, 132052, 131946, 131968],
                     [131974, 132114, 131963, 132097], [132097, 132142, 131968, 132041],
                     [132041, 132131, 132019, 132047], [132047, 132080, 131940, 131963],
                     [131957, 132052, 131907, 132035], [132035, 132075, 131873, 131923],
                     [131923, 131929, 131834, 131862], [131867, 131901, 131828, 131867],
                     [131862, 131890, 131784, 131800], [131800, 132002, 131789, 131935],
                     [131940, 132030, 131929, 132024], [132024, 132052, 131918, 131951],
                     [131951, 132002, 131912, 131974], [131974, 132024, 131840, 131840],
                     [131840, 131946, 131828, 131873], [131879, 131985, 131867, 131963],
                     [131957, 131985, 131845, 131901], [131901, 131979, 131812, 131946],
                     [131946, 132153, 131923, 131985], [131985, 132063, 131946, 132013],
                     [132013, 132103, 131985, 132007], [132007, 132030, 131929, 131957],
                     [131951, 132024, 131935, 131957], [131951, 131996, 131935, 131957],
                     [131957, 131968, 131834, 131901], [131907, 131923, 131884, 131890],
                     [131895, 132041, 131890, 132024], [132030, 132075, 131974, 132069],
                     [132058, 132108, 131979, 132097], [132097, 132119, 131963, 131963],
                     [131778, 131929, 131638, 131890], [131890, 132047, 131789, 131812],
                     [131812, 131823, 131666, 131728], [131728, 131784, 131655, 131711],
                     [131705, 131800, 131621, 131767], [131761, 131823, 131660, 131672],
                     [131672, 131867, 131638, 131812], [131817, 131918, 131812, 131862],
                     [131862, 131867, 131750, 131778], [131772, 131856, 131739, 131845],
                     [131845, 131901, 131800, 131834], [131834, 131862, 131728, 131778],
                     [131784, 131895, 131599, 131761], [131756, 132069, 131750, 132047],
                     [132047, 132198, 132007, 132119], [132125, 132164, 131957, 131985],
                     [131985, 131991, 131576, 131616], [131610, 131750, 131521, 131728],
                     [131728, 131991, 131593, 131638], [131632, 131862, 131610, 131744],
                     [131744, 131761, 131493, 131599], [131604, 131616, 131302, 131392],
                     [131392, 131453, 131246, 131291], [131297, 131341, 131213, 131280],
                     [131280, 131280, 131062, 131246], [131241, 131280, 131123, 131140],
                     [131140, 131375, 131112, 131347], [131353, 131448, 131302, 131420],
                     [131420, 131543, 131336, 131532], [131532, 131627, 131504, 131621],
                     [131621, 131722, 131571, 131649], [131655, 131739, 131576, 131728],
                     [131733, 131784, 131616, 131761], [131756, 131845, 131672, 131817],
                     [131817, 131890, 131744, 131750], [131756, 131840, 131677, 131767],
                     [131761, 131789, 131672, 131716], [131722, 131744, 131610, 131655],
                     [131649, 131700, 131588, 131655], [131649, 131761, 131582, 131705],
                     [131711, 131733, 131543, 131576], [131576, 131694, 131548, 131644],
                     [131649, 131733, 131537, 131571], [131576, 131672, 131548, 131621],
                     [131621, 131700, 131571, 131627], [131632, 131688, 131576, 131632],
                     [131632, 131700, 131554, 131560], [131560, 131599, 131521, 131588],
                     [131588, 131655, 131526, 131543], [131543, 131828, 131476, 131711],
                     [131705, 131728, 131560, 131644], [131638, 131694, 131576, 131666],
                     [131666, 131750, 131537, 131632], [131627, 131649, 131548, 131604],
                     [131610, 131666, 131526, 131571], [131576, 131789, 131554, 131772],
                     [131772, 131789, 131638, 131672], [131677, 131694, 131599, 131649],
                     [131649, 131851, 131638, 131806], [131806, 131996, 131767, 131974],
                     [131979, 132035, 131895, 131957], [131957, 132203, 131946, 132175],
                     [132175, 132338, 132103, 132147], [132147, 132164, 132086, 132091],
                     [132097, 132209, 132019, 132041], [132041, 132108, 131991, 132086],
                     [132086, 132276, 132069, 132254], [132254, 132265, 132131, 132181],
                     [132175, 132293, 132142, 132159], [132159, 132214, 132119, 132153],
                     [132153, 132153, 132069, 132114], [132108, 132310, 132047, 132103],
                     [132108, 132192, 132075, 132108], [132114, 132131, 132030, 132063],
                     [132069, 132080, 131963, 131979], [131985, 132013, 131851, 131879],
                     [131884, 131991, 131867, 131968], [131968, 132035, 131806, 131834],
                     [131834, 131879, 131789, 131851], [131856, 131895, 131800, 131879],
                     [131879, 131901, 131772, 131772], [131772, 131784, 131610, 131688],
                     [131688, 131733, 131638, 131638], [131644, 131649, 131459, 131470],
                     [131476, 131543, 131369, 131414], [131414, 131554, 131414, 131509],
                     [131515, 131604, 131498, 131593], [131593, 131649, 131526, 131582],
                     [131576, 131700, 131576, 131644], [131644, 131677, 131543, 131599],
                     [131604, 131604, 131470, 131487], [131493, 131515, 131414, 131481],
                     [131481, 131498, 131409, 131437], [131431, 131487, 131341, 131431],
                     [131437, 131548, 131386, 131476], [131476, 131604, 131476, 131588],
                     [131593, 131778, 131582, 131772], [131772, 131834, 131705, 131761],
                     [131761, 131873, 131728, 131834], [131834, 131923, 131812, 131895],
                     [131895, 131951, 131879, 131907], [131907, 131923, 131767, 131778],
                     [131778, 131795, 131660, 131688], [131688, 131733, 131666, 131728],
                     [131722, 131772, 131688, 131750], [131744, 131772, 131644, 131666],
                     [131666, 131722, 131610, 131638], [131420, 131470, 131157, 131425],
                     [131425, 131459, 131224, 131297], [131291, 131302, 131090, 131151],
                     [131151, 131168, 131022, 131050], [131050, 131129, 130994, 131073],
                     [131073, 131112, 131028, 131101], [131095, 131235, 131056, 131162],
                     [131157, 131179, 130961, 131062], [131067, 131129, 131056, 131106],
                     [131106, 131140, 131017, 131106], [131106, 131157, 131073, 131095],
                     [131101, 131118, 130983, 131000], [131006, 131034, 130793, 130838],
                     [130838, 130877, 130670, 130838], [130832, 130888, 130569, 130771],
                     [130771, 130888, 130698, 130832], [130838, 130888, 130620, 130659],
                     [130659, 130726, 130558, 130597], [130597, 130709, 130480, 130681],
                     [130687, 130771, 130647, 130681], [130681, 130838, 130653, 130776],
                     [130776, 131011, 130754, 130916], [130911, 131084, 130899, 131067],
                     [131067, 131106, 130978, 131084], [131084, 131140, 131006, 131123],
                     [131129, 131174, 131034, 131101], [131101, 131218, 131101, 131162],
                     [131157, 131213, 131045, 131179], [131179, 131230, 131118, 131134],
                     [131140, 131146, 131056, 131106], [131106, 131179, 131073, 131168],
                     [131168, 131174, 130994, 131039], [131039, 131095, 130944, 131006],
                     [131000, 131308, 130966, 130972], [130972, 131022, 130715, 130754],
                     [130748, 130821, 130603, 130793], [130787, 130810, 130720, 130804],
                     [130804, 130843, 130731, 130804], [130804, 130838, 130737, 130782],
                     [130782, 130899, 130748, 130843]]

        self.current_day_index = 0
        self.earnings = 0
        self.position = None
        self.current_price = 0

        # Earnings display
        # self.earnings_label = Label(text=f"Earnings: ${self.earnings}")
        # self.add_widget(self.earnings_label)

    def start_game(self, instance):
        self.current_day_index = random.randint(180, len(self.OHLC_data) - 1)
#        self.remove_widget(self.start_button)
        self.load_chart()

        # Trading buttons
        # self.buy_button = Button(text='Buy', on_press=self.buy_action)
        # self.sell_button = Button(text='Sell', on_press=self.sell_action)
        # self.pass_button = Button(text='Pass', on_press=self.pass_action)
        #
        # self.add_widget(self.buy_button)
        # self.add_widget(self.sell_button)
        # self.add_widget(self.pass_button)

    def build(self):
        self.root = Builder.load_string(kv_layout)
        self.load_chart()
        return self.root

    def load_chart(self):

        if self.chart_canvas and self.chart_canvas in self.ids.chart_area.children:
            self.ids.chart_area.remove_widget(self.chart_canvas)

        if self.chart_canvas:
            plt.close(self.chart_canvas.figure)

        self.current_price = self.OHLC_data[self.current_day_index][-1]  # Close price

        # Determine the starting index for the 180 bars leading up to the current day
        start_index = self.current_day_index - 179 if self.current_day_index - 179 >= 0 else 0
        subset_data = self.OHLC_data[start_index:self.current_day_index + 1]

        # Generate a list of dates for the subset data.
        end_date = datetime.today()
        start_date = end_date - timedelta(days=180)
        date_range = pd.date_range(start=start_date, end=end_date, closed='right')

        # Convert the subset data to a pandas DataFrame
        data = pd.DataFrame({
            'Open': [item[0] for item in subset_data],
            'High': [item[1] for item in subset_data],
            'Low': [item[2] for item in subset_data],
            'Close': [item[3] for item in subset_data]
        }, index=date_range)

        fig, ax = plt.subplots(figsize=(10, 5))
        mpf.plot(data, type='candle', ax=ax, mav=(3, 6, 9))

        # Remove the old chart before adding the new one
        if self.chart_canvas:
            self.main_layout.remove_widget(self.chart_canvas)

        # Add the plot to the Kivy layout
        self.chart_canvas = FigureCanvasKivyAgg(plt.gcf())
        self.ids.chart_area.add_widget(self.chart_canvas)

    def buy_action(self, instance):
        if not self.position:
            self.position = "bought"
            self.entry_price = self.current_price

        if self.position == "sold":
            profit = self.entry_price - self.current_price
            self.earnings += profit
            self.position = None
            self.ids.earnings_label.text = f"Earnings: ${self.earnings}"

    def sell_action(self, instance):
        if not self.position:
            self.position = "sold"
            self.entry_price = self.current_price

        if self.position == "bought":
            profit = self.current_price - self.entry_price
            self.earnings += profit
            self.position = None
            self.ids.earnings_label.text = f"Earnings: ${self.earnings}"

    def pass_action(self, instance):
        self.current_day_index += 1
        if self.current_day_index >= len(self.OHLC_data):
            self.end_of_day()
        else:
            self.load_chart()

    def end_of_day(self):
        # Logic to stop trading and show final earnings
        self.remove_widget(self.buy_button)
        self.remove_widget(self.sell_button)
        self.remove_widget(self.pass_button)
        self.add_widget(Label(text=f"Day Ended. Total Earnings: ${self.earnings}"))

if __name__ == "__main__":
    TradingSimulatorApp().run()
